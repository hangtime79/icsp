#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
VERSION="0.3.0"
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

help="
icsp - iCalendar (.ics) parser. v$VERSION

Reads an iCalendar stream from stdin (or from a file)
and outputs a CSV of it's contents to stdout.

Usage:
  icsp [-c columns] [-d delimiter] [-x component] [-hi] [file]

Options:
  -c <string>   Comma seperated list of fields to parse. Order is preserved, case insensitive.
  -d <string>   Delimiter character to use for seperating values. Default: ','
  -x <string>   ICS component to parse. Default: VEVENT
  -i            Format standard datetime columns to ISO format
  -r            Reverse conversion. CSV to ICS
  -h            Show this help text.

Examples:
  # Basic usage
  icsp calendar.ics > calendar.csv

  # Display specific fields as TSV
  icsp -c 'dtstart,summary,duration' -d $'\t' calendar.ics > calendar.tsv

  # Download calendar from the internet as CSV
  curl -s https://foobar/path/to/calendar.ics | icsp > calendar.csv
"

see_usage="See 'icsp -h' for usage."

throw() {
  echo "$@" 1>&2
  exit 1
}

# Run icsp
# ============

# Default option values
columns=""
delimiter=$'\t'
component="VEVENT"

# Parse options
while getopts "c:d:x:irh" arg; do
  case $arg in
    c) columns="$(echo "$OPTARG" | tr '[:lower:]' '[:upper:]')";;
    d) delimiter="$OPTARG";;
    x) component="$OPTARG";;
    i) iso_format="true";;
    r) reverse="true";;
    h) echo "$help"; exit 0;;
    *) throw "$see_usage";;
  esac
done
shift $((OPTIND - 1))

# Validate that there's stdin OR valid file path
if [[ -n ${1+x} ]]; then
  if [[ ! -f "$1" ]]; then
    throw "File \"$1\" does not exist. $see_usage"
  fi
else
  if [[ -t 0 ]]; then
    throw "No stdin or file specified. $see_usage"
  fi
fi

if [[ -z "${reverse:-}" ]]; then
  ### ICS to CSV
  # Read file or STDIN
  # Then collapse multi-line fields using awk
  # Then create a TSV of key:value ics fields
  # Then cleanup keys that have extra data after a ";" character
  # Then remove DOS carriage characters
  # Then convert the cleaned up ICS file to a CSV string using ics-to-csv.awk
  cat ${1:-} \
    | awk -v RS= '{gsub(/\r\n[[:blank:]]/,"")}1' \
    | sed 's/:/\t/' \
    | sed 's/;.*\t/\t/' \
    | tr -d $'\r' \
    | awk \
      -v OFS="$delimiter" \
      -v columns="$columns" \
      -v component="$component" \
      -v iso_format="${iso_format:-}" \
      -f "$SCRIPT_DIR/ics-to-csv.awk"
else
  cat ${1:-} \
    | awk \
      -v FS="$delimiter" \
      -v iso_format="${iso_format:-}" \
      -f "$SCRIPT_DIR/csv-to-ics.awk"
fi